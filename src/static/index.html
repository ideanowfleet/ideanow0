<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Management Dashboard</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard-header {
            background: #5e2d76;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alerts-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .alert-critical {
            background: #fee;
            border-left-color: #dc3545;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left-color: #17b845;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .filters-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #5e2d76;
        }
        
        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        
        .summary-card .label {
            color: #666;
            font-size: 14px;
        }
        
        .performance-table {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .performance-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .performance-table th,
        .performance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .performance-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .btn-refresh {
            background: #5e2d76;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-refresh:hover {
            background: #bd9ccd;
        }
        
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .dashboard-header {
            color: white;          
            padding: 20px;
        }

        .dashboard-header h1 {
            font-weight: bold;   
            margin: 0;
        }

        .dashboard-header p {
            margin: 5px 0 0 0;   
            font-weight: bold;    
        }

        .dashboard-header i {
           margin-right: 10px;     
           color: white;          
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add the date adapter for Chart.js (required for time scales) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div>
                <h1><i class="fa-solid fa-chart-line"></i> Fleet Management Dashboard</h1>
                <p>Real-time insights and analytics for your fleet operations</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <a href="/manage.html" 
                   style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 5px; transition: background-color 0.3s;"
                   onmouseover="this.style.backgroundColor='#bd9ccd';"
                   onmouseout="this.style.backgroundColor='';">
                  <i class="fas fa-cogs"></i> Manage
                </a>
                
                <a href="/reports.html" 
                   style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 5px; transition: background-color 0.3s;"
                   onmouseover="this.style.backgroundColor='#bd9ccd';"
                   onmouseout="this.style.backgroundColor='';">
                  <i class="fas fa-chart-bar"></i> Reports
                </a>
                <button class="btn-refresh" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section">
            <h2><i class="fas fa-exclamation-triangle"></i> Alerts & Notifications</h2>
            <div id="alertsContainer">
                <div class="no-data">Loading alerts...</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <h3><i class="fas fa-filter"></i> Filters</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="truckFilter">Truck</label>
                    <select id="truckFilter" onchange="applyFilters()">
                        <option value="">All Trucks</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="driverFilter">Driver</label>
                    <select id="driverFilter" onchange="applyFilters()">
                        <option value="">All Drivers</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="regionFilter">Region</label>
                    <select id="regionFilter" onchange="applyFilters()">
                        <option value="">All Regions</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="timeFilter">Time Period</label>
                    <select id="timeFilter" onchange="applyFilters()">
                        <option value="30">Last 30 days</option>
                        <option value="7">Last 7 days</option>
                        <option value="90">Last 3 months</option>
                        <option value="365">Last year</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="icon"><i class="fas fa-route"></i></div>
                <div class="value" id="totalTrips">-</div>
                <div class="label">Total Trips</div>
            </div>
            <div class="summary-card">
                <div class="icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="value" id="totalRevenue">-</div>
                <div class="label">Total Revenue</div>
            </div>
            <div class="summary-card">
                <div class="icon"><i class="fas fa-road"></i></div>
                <div class="value" id="totalDistance">-</div>
                <div class="label">Total Distance (km)</div>
            </div>
            <div class="summary-card">
                <div class="icon"><i class="fas fa-gas-pump"></i></div>
                <div class="value" id="avgEfficiency">-</div>
                <div class="label">Avg Fuel Efficiency (km/l)</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Profit Trends Chart -->
            <div class="chart-container">
                <div class="chart-title">Profit Trends</div>
                <canvas id="profitChart" width="400" height="200"></canvas>
            </div>

            <!-- Fuel Usage Chart -->
            <div class="chart-container">
                <div class="chart-title">Fuel Usage by Truck</div>
                <canvas id="fuelChart" width="400" height="200"></canvas>
            </div>

            <!-- Fuel Efficiency Chart -->
            <div class="chart-container">
                <div class="chart-title">Fuel Efficiency Trends</div>
                <canvas id="efficiencyChart" width="400" height="200"></canvas>
            </div>

            <!-- Revenue vs Expenses Chart -->
            <div class="chart-container">
                <div class="chart-title">Revenue vs Expenses</div>
                <canvas id="revenueExpenseChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- High Performing Trucks Table -->
        <div class="performance-table">
            <h3><i class="fas fa-trophy"></i> High Performing Trucks</h3>
            <table>
                <thead>
                    <tr>
                        <th>Truck Number</th>
                        <th>Total Trips</th>
                        <th>Revenue</th>
                        <th>Profit</th>
                        <th>Distance (km)</th>
                        <th>Avg Profit/Trip</th>
                    </tr>
                </thead>
                <tbody id="performanceTableBody">
                    <tr>
                        <td colspan="6" class="no-data">Loading performance data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let charts = {};
        let currentFilters = {
            truck_id: '',
            driver_id: '',
            region: '',
            days: 30
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadFilters();
            loadDashboardData();
        });

        async function loadFilters() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/dashboard/filters', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    populateFilters(data.filters);
                }
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }

        function populateFilters(filters) {
            const truckSelect = document.getElementById('truckFilter');
            filters.trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck.id;
                option.textContent = truck.label;
                truckSelect.appendChild(option);
            });

            const driverSelect = document.getElementById('driverFilter');
            filters.drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = driver.label;
                driverSelect.appendChild(option);
            });

            const regionSelect = document.getElementById('regionFilter');
            filters.regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region.id;
                option.textContent = region.label;
                regionSelect.appendChild(option);
            });
        }

        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('token');
                
                // Load alerts
                const alertsResponse = await fetch('/api/dashboard/alerts', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (alertsResponse.ok) {
                    const alertsData = await alertsResponse.json();
                    displayAlerts(alertsData.alerts);
                }

                // Load analytics
                const params = new URLSearchParams(currentFilters);
                const analyticsResponse = await fetch(`/api/dashboard/analytics?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (analyticsResponse.ok) {
                    const analyticsData = await analyticsResponse.json();
                    displayAnalytics(analyticsData.analytics);
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alertsContainer');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="no-data">No alerts at this time</div>';
                return;
            }

            container.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.severity}">
                    <div style="margin-right: 15px;">
                         <i class="fas ${alert.type === 'document_expiry' ? 'fa-file-alt' : 'fa-truck'}"></i>
                    </div>
                    <div>
                       <strong>${alert.title}</strong><br>
                       <span>${alert.message}</span>
                       ${alert.alert_date ? `<br><span style="color:#444;"><b>Expiry Date:</b> ${alert.alert_date}</span>` : ""}
                    </div>
                 </div>
           `).join('');
        }

        function displayAnalytics(analytics) {
            // Update summary cards
            document.getElementById('totalTrips').textContent = analytics.summary.total_trips;
            document.getElementById('totalRevenue').textContent = `$${analytics.summary.total_revenue.toLocaleString()}`;
            document.getElementById('totalDistance').textContent = analytics.summary.total_distance.toLocaleString();
            document.getElementById('avgEfficiency').textContent = analytics.summary.avg_fuel_efficiency;

            // Create charts (always destroy old chart instances before creating new ones)
            createProfitChart(analytics.profit_trends);
            createFuelChart(analytics.fuel_usage);
            createEfficiencyChart(analytics.fuel_efficiency);
            createRevenueExpenseChart(analytics.profit_trends);

            // Update performance table
            updatePerformanceTable(analytics.high_performing_trucks);
        }

        function createProfitChart(data) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            if (charts.profit) charts.profit.destroy();
            charts.profit = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Profit',
                        data: data.map(d => d.profit),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createFuelChart(data) {
            const ctx = document.getElementById('fuelChart').getContext('2d');
            if (charts.fuel) charts.fuel.destroy();
            charts.fuel = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.truck_number),
                    datasets: [{
                        label: 'Fuel Consumed (L)',
                        data: data.map(d => d.fuel_consumed),
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createEfficiencyChart(data) {
            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            if (charts.efficiency) charts.efficiency.destroy();
            charts.efficiency = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Fuel Efficiency (km/l)',
                        data: data.map(d => ({
                            x: d.date,
                            y: d.efficiency
                        })),
                        backgroundColor: '#ffc107'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createRevenueExpenseChart(data) {
            const ctx = document.getElementById('revenueExpenseChart').getContext('2d');
            if (charts.revenueExpense) charts.revenueExpense.destroy();
            charts.revenueExpense = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Revenue',
                        data: data.map(d => d.revenue),
                        backgroundColor: '#28a745'
                    }, {
                        label: 'Expenses',
                        data: data.map(d => d.expenses),
                        backgroundColor: '#dc3545'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updatePerformanceTable(trucks) {
            const tbody = document.getElementById('performanceTableBody');
            
            if (!trucks || trucks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No performance data available</td></tr>';
                return;
            }

            tbody.innerHTML = trucks.map(truck => `
                <tr>
                    <td>${truck.truck_number}</td>
                    <td>${truck.trips}</td>
                    <td>$${truck.revenue.toLocaleString()}</td>
                    <td>$${truck.profit.toLocaleString()}</td>
                    <td>${truck.distance.toLocaleString()}</td>
                    <td>$${truck.avg_profit_per_trip.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        function applyFilters() {
            currentFilters.truck_id = document.getElementById('truckFilter').value;
            currentFilters.driver_id = document.getElementById('driverFilter').value;
            currentFilters.region = document.getElementById('regionFilter').value;
            currentFilters.days = document.getElementById('timeFilter').value;
            loadDashboardData();
        }

        function refreshDashboard() {
            loadDashboardData();
        }
    </script>
</body>
<footer style="text-align: center; padding: 8px 0; background-color: #f9f9f9;">
    <div style="
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
      color: rgb(96, 19, 109);">
      <img src="image/ideanow-logo.png" alt="IDEANOW Logo" style="height: 45px;">
      <span>Powered by <strong>IDEANOW</strong></span>
    </div>
</footer>
</html>